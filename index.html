<!DOCTYPE html>

<html>
<head>
  <title>atoum\instrumentation</title>
  <meta http-equiv="content-type" content="text/html;       charset=utf-8" />
  <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
  <meta http-equiv="content-type" content="text/css;        charset=utf-8" />

  <link type="text/css" href="http://static.hoa-project.net/Css/Keynote.css" rel="stylesheet" />
  <style>
    section {
        background: url("http://downloads.atoum.org/images/logo.png") 98% 1em / 80px no-repeat;
    }

    .view section {
        background: url("http://downloads.atoum.org/images/logo.png") 98% 1em / 80px no-repeat,
                    #fff url("http://static.hoa-project.net/Image/Background_paper.png");
    }

    table {
        text-align: center;
        margin: 0 auto;
        max-width: 90%;
        border-collapse: collapse;
    }

    table > thead {
        border: 1px #000 solid;
        border-width: 2px 0;
    }

    table th {
        padding: 0 1em;
        border-bottom: 1px #000 solid;
    }

    table td {
        padding: 0 1em;
        border-top: 1px #000 solid;
    }

    table > tbody > tr {
        border: 1px #000 solid;
        border-width: 1px 0;
    }

    table > tbody::before {
        line-height: 1px;
        content: "¬†";
        visibility: hidden;
        display: block;
    }

    table > tbody.first-column-align-start > tr > td:first-child {
        text-align: left;
    }

    .üëç {
        color: green;
    }

    .üëé {
        color: red;
    }

    svg {
        margin: 0; auto;
        border: 1px black solid;
        text-align: center;
    }

    svg rect, svg path {
        fill: none;
        stroke: #000;
        stroke-width: .5;
        stroke-linejoin: round;
    }

    svg rect {
        stroke-linecap: round;
    }

    svg text {
        font-family: "Andale Mono";
        font-size: 10pt;
        text-anchor: middle;
        dominant-baseline: middle;
    }

    svg text.small {
        font-size: 5pt;
    }

    svg .fill {
        fill: #000;
    }

    svg .control > rect {
        fill: #fff;
    }

    svg .annotation > text {
        font-size: 10pt;
    }

    svg .start {
        text-anchor: start;
    }

    svg .end {
        text-anchor: end;
    }
  </style>
</head>
<body>

<script src="http://static.hoa-project.net/Javascript/Hoa.js"></script>

<section>
  <h1><code>atoum\instrumentation</code></h1>

  <p class="tcenter" style="margin-top: 30%">a short introduction</p>
</section>

<section>
  <h1>Instrumentation</h1>

  <blockquote cite="http://en.wikipedia.org/wiki/Instrumentation_%28computer_programming%29">instrumentation
  refers to an ability to monitor or measure the level of a product's
  performance, to diagnose errors and to write trace information. [‚Ä¶]
  Instrumentation approaches can be of two types, source instrumentation and
  binary instrumentation.</blockquote>
  <p>PHP is interpreted, so we have to rely only on source code, not the
  binary.</p>
</section>

<section>
  <h1>Usual process</h1>

  <p>How to instrument a language? Interfere in its compiling process, which
  is:</p>
  <ul>
    <li>lexically analyze the source code,</li>
    <li data-item="+">modify the produced tokens sequence,</li>
    <li>syntactically analyze the resulting tokens sequence,</li>
    <li>build an AST (if available),</li>
    <li>interprete (= execute) or compile (= transform into another language)
    it.</li>
  </ul>
</section>

<section>
  <h1>Original vs. instrumented</h1>

  <p>Two versions of the code exist:</p>
  <ul>
    <li>the original one,</li>
    <li>the instrumented one.</li>
  </ul>
  <p>In test environment, switch to the instrumented version.</p>
  <p>Laborious process:</p>
  <ul>
    <li data-item="‚Äî">‚ÄúI have edited my file‚Äù</li>
    <li data-item="‚Äî">‚ÄúI have to reinstrument the code‚Äù ‚Üê ouuhhh!</li>
    <li data-item="‚Äî">‚ÄúI have to run the tests‚Äù</li>
  </ul>
  <p>Solution: instrument <strong>on-the-fly</strong>!</p>
</section>

<section class="chapter">
  <h1>1 <span>Instrumentation on-the-fly</span></h1>
</section>

<section>
  <h1><code>instrument://</code> wrapper</h1>

  <p>What we do to interprete a file:</p>
  <pre><code class="language-php">require 'Foo.php';</code></pre>
  <p>What we have to do to instrument a file on-the-fly:</p>
  <pre><code class="language-php">require 'instrument://Foo.php';</code></pre>
  <p><code>instrument://</code> is a user-defined stream wrapper:</p>
  <ol>
    <li>get the resource name to interprete (<code>Foo.php</code>),</li>
    <li>get some options for the instrumentation,</li>
    <li>open the resource,</li>
    <li><strong>apply the <code>instrument</code> filter on the
    resource</strong>.</li>
  </ol>
  <p>Tips: autoloaders simply prefix URI by <code>instrument://</code>!</p>
</section>

<section>
  <h1><code>instrument</code> filter</h1>

  <div id="filter" class="schema"></div>
  <script>
  Hoa.Document.onReady(function ( ) {

      var paper = Hoa.Graph(Hoa.$('#filter'), 700, 150);
      var grid  = paper.grid(0, 0, 700, 150, 3, 1);
      var step1 = grid.push(paper.rect(0, 0, 150, 90, 3, 'require'));
      var step2 = grid.push(paper.rect(0, 0, 150, 90, 3, 'filter'));
      var step3 = grid.push(paper.rect(0, 0, 150, 90, 3, 'filesystem, ‚Ä¶'));

      paper.link.between(step1, step2, 'read');
      paper.link.between(step2, step3, 'read');
  });
  </script>
  <p>A filter is composed of <strong>brigades</strong> that exchange
  <strong>buckets</strong> of data amongst themselves.</p>
  <p>A filter is able to <strong>compute</strong> data inside buckets.</p>
  <p>A <em>late computed</em> filter computes all the data once on closing.</p>
  <p class="break">The <code>instrument</code> filter is a late computed filter
  that read PHP source code!</p>
</section>

<section>
  <h1>Filter computation</h1>

  <p>Use the <code>token_get_all</code> native PHP function to get the tokens
  sequence of the source:</p>
  <ul>
    <li>traverse this sequence and find patterns‚Ä¶</li>
    <li>when one matches, splice a portion of the sequence by another‚Ä¶</li>
  </ul>
  <p>‚Ä¶ until reaching the end of the sequence; then reconstitute the source and
  let PHP do the rest!</p>
  <p>Trivial example: search <code class="language-php">['if', '(', ‚Ä¶,
  ')']</code> and replace by <code class="language-php">['if', '(',
  'mark_cond(\3)', ')']</code>. Thus: <code class="language-php">if('bar' ===
  $baz)</code> becomes: <code class="language-php">if(mark_cond('bar' ===
  $baz))</code>.</p>
</section>

<section>
  <h1>Overview</h1>

  <p>We are able to instrument <strong>any</strong> file <strong>before</strong>
  it is interpreted by PHP, <strong>on-the-fly</strong>, at
  <strong>low-cost</strong>, with <strong>pure</strong> PHP code. And only by
  adding <code>instrument://</code> on URI.</p>
  <p class="break">Next, what we make with the instrumentation is:</p>
  <ul>
    <li>options,</li>
    <li>moles,</li>
    <li>code coverage.</li>
  </ul>
</section>

<section class="chapter">
  <h1>2 <span>Options</span></h1>
</section>

<section>
  <h1>Syntax of <code>instrument://</code></h1>

  <p>The full syntax of the <code>instrument://</code> URI is:</p>
  <p class="tcenter"><code>instrument://[<em>options</em>/resource=]?<em>resource</em></code></p>
  <p>where <code><em>options</em></code> is:</p>
  <p class="tcenter"><code>options=[[+-]?<em>option</em>[,[+-]?<em>option</em>]*]?</code></p>
  <p>and <code><em>resource</em></code> is a valid URI.</p>
  <p>Example of disabling moles (<code>-moles</code>):</p>
  <pre><code class="language-php">require 'instrument://options=-moles/resource=Foo.php';</code></pre>
</section>

<section class="chapter">
  <h1>3 <span>Moles</span></h1>
</section>

<section>
  <h1>Limitations of mock</h1>

  <p>A mock is a class <code>MC</code> that <strong>extends</strong> an existing
  one <code>C</code>.</p>
  <p>Almost each method can be redefined/re-implemented.</p>
  <p>Current issues:</p>
  <ul>
    <li>redefining private methods is not possible,</li>
    <li>redefining final methods is not possible,</li>
    <li>redefining parent methods of a child class is not possible,</li>
    <li>redefining static methods called with <code>self</code> is not
    possible,</li>
    <li>cannot access to private attributes.</li>
  </ul>
</section>

<section>
  <h1>Moles in a nutshell</h1>

  <p>Original code:</p>
  <pre><code class="language-php">    public function f ( $x, $y ) {

        // ‚Ä¶
    }</code></pre>
  <p>‚ÄúMoled‚Äù code:</p>
  <pre><code class="language-php">    public function f ( $x, $y ) {

        if(true === mole_exists('C::f'))
            return mole_call([$this, 'f'], func_get_args());

        // ‚Ä¶
    }</code></pre>
  <p>Mocks are <strong>external</strong> to the original code.</p>
  <p>Moles are <strong>inside</strong> the original code.</p>
</section>

<section>
  <h1>Moles in action <small>(1/2)</small></h1>

  <p>Original code <code>Example/C.php</code>:</p>
  <pre><code class="language-php">namespace Example;

class C {

    public function f ( $x ) {

        return $x * 2;
    }
}</code></pre>
  <p>Goal: modify the behavior of <code>Example\C::f</code> (thanks to the
  instrumentation!).</p>
</section>

<section>
  <h1>Moles in action <small>(2/2)</small></h1>

  <p>Use <code>instrument://</code> and <code>mole::register</code>:</p>
  <pre><code class="language-php">use atoum\instrumentation\mole;
require 'instrument://Example/C.php';

$c = new Example\C();

// Call the real `Example\C::f` method.
var_dump($c->f(42)); // int(84)

// Register a mole for the `Example\C::f` method.
mole::register('Example\C::f', function ( $x ) {

    return $x / 2;
});

// The `Example\C::f` method uses the registered mole!
var_dump($c->f(42)); // int(21)</code></pre>
  <p><code>Example\C::f</code> has been redefined dynamically!</p>
</section>

<section>
  <h1>Mock vs. mole</h1>

  <table>
    <thead>
      <tr>
        <th></th>
        <th>mock</th>
        <th>mole</th>
      </tr>
    </thead>
    <tbody class="first-column-align-start">
      <tr>
        <td>private methods</td>
        <td class="üëé">‚úñÔ∏é</td>
        <td class="üëç">‚úîÔ∏é</td>
      </tr>
      <tr>
        <td>final methods</td>
        <td class="üëé">‚úñÔ∏é</td>
        <td class="üëç">‚úîÔ∏é</td>
      </tr>
      <tr>
        <td>parent methods</td>
        <td class="üëé">‚úñÔ∏é</td>
        <td class="üëç">‚úîÔ∏é</td>
      </tr>
      <tr>
        <td>static methods <small>(called with <code>self</code>)</small></td>
        <td class="üëé">‚úñÔ∏é</td>
        <td class="üëç">‚úîÔ∏é</td>
      </tr>
      <tr>
        <td>private attributes</td>
        <td class="üëé">‚úñÔ∏é</td>
        <td class="üëç">‚úîÔ∏é</td>
      </tr>
      <tr>
        <td>modify existing code</td>
        <td class="üëç">‚úîÔ∏é</td>
        <td class="üëé">‚úñÔ∏é</td>
      </tr>
    </tbody>
  </table>
</section>

<section class="chapter">
  <h1>4 <span>Code coverage</span></h1>
</section>

<section>
  <h1>Control Flow Graph</h1>
</section>

<section>
  <h1>Hierarchy of code coverage criteria</h1>

  <svg height="375" viewBox="0 0 300 200">>
    <g class="control">
      <path d="M 225, 120 L 225,  20" class="dashed" />
      <path d="M 225, 160 L 225, 120" />
      <path d="M 225, 180 L 225, 160" />

      <path d="M 225, 160 L 120, 125" />
      <path d="M  75, 160 L 120, 125" />
      <path d="M  75, 160 L  30, 125" />

      <path d="M  30, 125 L  75,  80" />
      <path d="M 120, 125 L  75,  80" />
      <path d="M  75,  80 L  75,  60" />
      <path d="M  75,  60 L 225,  20" />

      <rect x="185"  y="12" width="80" height="16" rx="5" ry="5" />
      <rect x="185" y="112" width="80" height="16" rx="5" ry="5" />
      <rect x="185" y="152" width="80" height="16" rx="5" ry="5" />
      <rect x="185" y="172" width="80" height="16" rx="5" ry="5" />

      <rect  x="1" y="112" width="58" height="26" rx="5" ry="5" />
      <rect  x="91" y="112" width="58" height="26" rx="5" ry="5" />

      <rect  x="25" y="152" width="100" height="16" rx="5" ry="5" />
      <rect  x="25"  y="72" width="100" height="16" rx="5" ry="5" />
      <rect  x="25"  y="52" width="100" height="16" rx="5" ry="5" />
    </g>

    <g class="label">
      <text x="225" y="20" class="small">all-paths</text>
      <text x="225" y="120" class="small">all-i-paths</text>
      <text x="225" y="160" class="small">all-transitions</text>
      <text x="225" y="180" class="small">all-nodes</text>

      <text x="30" y="120" class="small">all-c-</text>
      <text x="30" y="130" class="small">uses</text>
      <text x="120" y="120" class="small">all-p-</text>
      <text x="120" y="130" class="small">uses</text>

      <text x="75" y="60" class="small">all-DU-paths</text>
      <text x="75" y="80" class="small">all-uses</text>
      <text x="75" y="160" class="small">all-definitions</text>
    </g>
  </svg>
</section>

<section>
  <h1>Criterion: ‚Äúall-transitions‚Äù</h1>
</section>

<div id="progress-bar"></div>

<script src="http://static.hoa-project.net/Javascript/Keynote.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.hoa.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.plugin.line.js"></script>
<script src="http://static.hoa-project.net/Javascript/Hoa.Graph.js"></script>
<script src="http://static.hoa-project.net/Javascript/Hoa.Graph.style.js"></script>

</body>
</html>
