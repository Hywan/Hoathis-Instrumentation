<!DOCTYPE html>

<html>
<head>
  <title>atoum\instrumentation</title>
  <meta http-equiv="content-type" content="text/html;       charset=utf-8" />
  <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
  <meta http-equiv="content-type" content="text/css;        charset=utf-8" />

  <link type="text/css" href="http://static.hoa-project.net/Css/Keynote.css" rel="stylesheet" />
  <style>
    section {
        background: url("http://downloads.atoum.org/images/logo.png") 98% 1em / 80px no-repeat;
    }

    .view section {
        background: url("http://downloads.atoum.org/images/logo.png") 98% 1em / 80px no-repeat,
                    #fff url("http://static.hoa-project.net/Image/Background_paper.png");
    }
  </style>
</head>
<body>

<script src="http://static.hoa-project.net/Javascript/Hoa.js"></script>

<section>
  <h1><code>atoum\instrumentation</code></h1>

  <p class="tcenter" style="margin-top: 30%">a short introduction</p>
</section>

<section>
  <h1>Instrumentation</h1>

  <blockquote cite="http://en.wikipedia.org/wiki/Instrumentation_%28computer_programming%29">instrumentation
  refers to an ability to monitor or measure the level of a product's
  performance, to diagnose errors and to write trace information. […]
  Instrumentation approaches can be of two types, source instrumentation and
  binary instrumentation.</blockquote>
  <p>PHP is interpreted, so we have to rely only on source code.</p>
</section>

<section>
  <h1>Usual process</h1>

  <p>How to instrument a language? Interfere in the compiling process:</p>
  <ul>
    <li>lexically analyze the source code,</li>
    <li data-item="+">modify the produced tokens sequence,</li>
    <li>syntactically analyze the resulting tokens sequence,</li>
    <li>build an AST,</li>
    <li>interprete (= execute) or compile (= transform into another language)
    the AST.</li>
  </ul>
</section>

<section>
  <h1>Original vs. intrumented</h1>

  <p>Two versions of the code exist:</p>
  <ul>
    <li>the original one,</li>
    <li>the instrumented one.</li>
  </ul>
  <p>In test environment, switch to the instrumented version.</p>
  <p>Laborious process:</p>
  <ul>
    <li data-item="—">“I have edited my file”</li>
    <li data-item="—">“I have to reinstrument the code” ← ouuhhh!</li>
    <li data-item="—">“I have to run the tests”</li>
  </ul>
  <p>Solution: instrument <strong>on-the-fly</strong>!</p>
</section>

<section>
  <h1>Wrapper <code>instrument://</code></h1>

  <p>What we do to interprete a file:</p>
  <pre><code class="language-php">require 'Foo.php';</code></pre>
  <p>What we have to do to instrument a file on-the-fly:</p>
  <pre><code class="language-php">require 'instrument://Foo.php';</code></pre>
  <p><code>instrument://</code> is a user-defined stream wrapper:</p>
  <ul>
    <li>get the resource name to interprete (<code>Foo.php</code>),</li>
    <li>get some parameters for the interpretation,</li>
    <li>open the resource,</li>
    <li>apply the <code>instrument</code> <strong>filter</strong> on the
    resource.</li>
  </ul>
  <p>Tips: autoloaders simply prefix URI by <code>instrument://</code>!</p>
</section>

<section>
  <h1>Filter <code>instrument</code></h1>

  <div id="filter" class="schema"></div>
  <script>
  Hoa.Document.onReady(function ( ) {

      var paper = Hoa.Graph(Hoa.$('#filter'), 700, 150);
      var grid  = paper.grid(0, 0, 700, 150, 3, 1);
      var step1 = grid.push(paper.rect(0, 0, 150, 90, 3, 'require'));
      var step2 = grid.push(paper.rect(0, 0, 150, 90, 3, 'filter'));
      var step3 = grid.push(paper.rect(0, 0, 150, 90, 3, 'filesystem, …'));

      paper.link.between(step1, step2, 'read');
      paper.link.between(step2, step3, 'read');
  });
  </script>
  <p>A filter is composed of <strong>brigades</strong> that exchange
  <strong>buckets</strong> of data amongst themselves.</p>
  <p>A filter is able to <strong>compute</strong> data inside buckets.</p>
  <p>A <em>late computed</em> filter computes all the data once on closing.</p>
  <p>The <code>instrument</code> filter is a late computed filter that read PHP
  source code!</p>
</section>

<section>
  <h1>Filter computation</h1>

  <ul>
    <li>use the <code>token_get_all</code> native PHP function to lex the code
    (i.e. get a sequence of tokens),</li>
    <li>traverse this sequence and find patterns,</li>
    <li>when a pattern matches, splice a portion of the sequence by
    another.</li>
  </ul>
  <p>Example, search <code class="language-php">['if', '(', …, ')']</code>
  and replace by <code class="language-php">['if', '(', 'mark_cond(\3)',
  ')']</code>:</p>
  <pre><code class="language-php">if('bar' === $baz)</code></pre>
  <p>becomes:</p>
  <pre><code class="language-php">if(mark_cond('bar' === $baz))</code></pre>
</section>

<section>
  <h1>Awesome! Next?</h1>

  <p>What we would like to introduce:</p>
  <ul>
    <li>moles,</li>
    <li>code coverage.</li>
  </ul>
</section>

<section>
  <h1>Moles</h1>
</section>

<section>
  <h1>Moles in action <small>(1/2)</small></h1>

  <p>Original code <code>Example/C.php</code>:</p>
  <pre><code class="language-php">&lt;?php

namespace Example;

class C {

    public function f ( $x ) {

        return $x * 2;
    }
}</code></pre>
  <p>Goal: modify the behavior of <code>Example\C::f</code>.</p>
</section>

<section>
  <h1>Moles in action <small>(2/2)</small></h1>

  <p>Use <code>instrument://</code> and <code>mole::register</code>:</p>
  <pre><code class="language-php">use atoum\instrumentation\stream\wrapper;
use atoum\instrumentation\mole;

wrapper::register();
require 'instrument://Example/C.php';

$c = new Example\C();

// Real Example\C::f method.
var_dump($c->f(42)); // int(84):

// Register a mole for Example\C::f.
mole::register('Example\C::f', function ( $x ) {

    return $x / 2;
});

// Example\C::f uses the registed mole!
var_dump($c->f(42)); // int(21);</code></pre>
</section>


<div id="progress-bar"></div>

<script src="http://static.hoa-project.net/Javascript/Keynote.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.hoa.js"></script>
<script src="http://static.hoa-project.net/Javascript/Prism.plugin.line.js"></script>
<script src="http://static.hoa-project.net/Javascript/Hoa.Graph.js"></script>
<script src="http://static.hoa-project.net/Javascript/Hoa.Graph.style.js"></script>

</body>
</html>
